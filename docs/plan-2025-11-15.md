## ğŸš€ å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤è¨ˆç”»ï¼šNext.js + Docker + Cloudflare Tunnel

### Phase 1: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®DockeråŒ–ã¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™

ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ã€Next.jsã‚’æœ¬ç•ªç’°å¢ƒå‘ã‘ã«æœ€é©åŒ–ã—ã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã‚ˆã†ã«æº–å‚™ã—ã¾ã™ã€‚

#### 1.1 Next.js è¨­å®šã®æ›´æ–° (`next.config.ts`)

Next.jsã®`standalone`å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã€Dockerã®ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’æœ€é©åŒ–ã—ã¾ã™ã€‚

```typescript
// nemuilemon/denno-meishi/denno-meishi-77897f5adefdda842fd8ba0f77b85885ad2887a1/next.config.ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  output: 'standalone', // Dockerç”¨ã®æœ€é©åŒ–
};

export default nextConfig;
```

#### 1.2 Dockerfileã®ä½œæˆã¨ä¿®æ­£

Prisma Clientã®ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`src/generated`ï¼‰ã®ã‚³ãƒ”ãƒ¼ã‚’æ˜ç¤ºçš„ã«è¿½åŠ ã—ã€Next.jsã‚¢ãƒ—ãƒªã®èµ·å‹•ã«å¿…è¦ãªå…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒ³ãƒ†ãƒŠã«ç¢ºå®Ÿã«å«ã¾ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```dockerfile
# Dockerfile (ä¿®æ­£ç‰ˆã€æŠœç²‹)

# ... (deps, builder ã‚¹ãƒ†ãƒ¼ã‚¸ã¯å¤‰æ›´ãªã—)

# å®Ÿè¡Œå±¤ (æœ€å°ã‚µã‚¤ã‚º)
FROM base AS runner
WORKDIR /app

# ... (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ç’°å¢ƒå¤‰æ•°è¨­å®šã¯å¤‰æ›´ãªã—)

# ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚³ãƒ”ãƒ¼
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
# ã€ä¿®æ­£ç‚¹ã€‘Prisma Clientã®ç”Ÿæˆç‰©ï¼ˆsrc/generatedï¼‰ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder --chown=nextjs:nodejs /app/src/generated ./src/generated
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder /app/prisma ./prisma

USER nextjs

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

CMD ["node", "server.js"]
```

#### 1.3 .dockerignoreã®ä½œæˆ

```
# .dockerignore
# ... (æ—¢å­˜ã®å†…å®¹ã«åŠ ãˆã¦ä»¥ä¸‹ã‚’ç¢ºèª)
.env*
postgres-data
# ...
```

`.env*`ã‚’ç„¡è¦–ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã€æ©Ÿå¯†æƒ…å ±ãŒDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«å«ã¾ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

-----

### Phase 2: Docker Composeã¨Cloudflare Tunnelã®çµ±åˆ

Next.jsã‚¢ãƒ—ãƒªã®ãƒãƒ¼ãƒˆã‚’ãƒ›ã‚¹ãƒˆã«å…¬é–‹ã›ãšã€`cloudflared`ã‚³ãƒ³ãƒ†ãƒŠçµŒç”±ã§ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

#### 2.1 docker-compose.yml ã®æ›´æ–°ï¼ˆNext.jsãƒãƒ¼ãƒˆã®éš”é›¢ï¼‰

`app`ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰`ports: "3000:3000"`ã‚’å‰Šé™¤ã—ã€`denno_network`å†…éƒ¨ã§ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã—ã¾ã™ã€‚

```yaml
# docker-compose.yml (ä¿®æ­£ç‰ˆã€æŠœç²‹)
services:
  # ... (db, adminer ã‚µãƒ¼ãƒ“ã‚¹ã¯å¤‰æ›´ãªã—)

  # Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ (app)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: denno_meishi_app
    restart: unless-stopped
    # ã€ä¿®æ­£ç‚¹ã€‘ãƒãƒ¼ãƒˆã‚’ãƒ›ã‚¹ãƒˆã«å…¬é–‹ã—ãªã„ãŸã‚ã€portsã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    # ports:
    #   - "3000:3000"
    environment:
      - NODE_ENV=production
      # DB_PASSWORDã‚’.envã‹ã‚‰å–å¾—
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD:-Your_Super_Secret_Password}@db:5432/denno_meishi
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin_password}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - denno_network
    volumes:
      - ./prisma:/app/prisma

  # Cloudflare Tunnel (cloudflared)
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: denno_meishi_tunnel
    restart: unless-stopped
    # Cloudflareã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨èªè¨¼æƒ…å ±ã‚’ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¨ã—ã¦ãƒã‚¦ãƒ³ãƒˆ
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflared-config.yml:/etc/cloudflared/config.yml:ro
      # ã€é‡è¦ã€‘ãƒ›ã‚¹ãƒˆOSä¸Šã®èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®çµ¶å¯¾ãƒ‘ã‚¹ã‚’ç’°å¢ƒå¤‰æ•°ã§æŒ‡å®šã—ã¾ã™
      - ${CLOUDFLARED_CREDENTIALS}:/etc/cloudflared/credentials.json:ro
    networks:
      - denno_network
    depends_on:
      - app
      
# ... (volumes, networks ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å¤‰æ›´ãªã—)
```

#### 2.2 cloudflared-config.yml ã®ä½œæˆï¼ˆå†…éƒ¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰

`cloudflared`ãŒDockerå†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§`app`ã‚µãƒ¼ãƒ“ã‚¹åã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```yaml
# cloudflared-config.yml (ä¿®æ­£ç‰ˆ)
tunnel: <YOUR_TUNNEL_ID>
credentials-file: /etc/cloudflared/credentials.json # ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã®credentials.jsonã®ãƒ‘ã‚¹

ingress:
  - hostname: yourdomain.com
    service: http://app:3000 # ã€ä¿®æ­£ç‚¹ã€‘ã‚µãƒ¼ãƒ“ã‚¹å 'app' ã‚’ä½¿ç”¨
  - hostname: www.yourdomain.com
    service: http://app:3000 # ã€ä¿®æ­£ç‚¹ã€‘ã‚µãƒ¼ãƒ“ã‚¹å 'app' ã‚’ä½¿ç”¨
  - service: http_status:404
```

#### 2.3 ç’°å¢ƒå¤‰æ•°è¨­å®š (`.env`)

`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã€Cloudflare Tunnelã®èªè¨¼æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```env
# .env (æŠœç²‹)

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
DB_PASSWORD=your_strong_production_password

# ç®¡ç†è€…èªè¨¼
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your_admin_password

# Next.jsè¨­å®š
DATABASE_URL=postgresql://postgres:your_strong_production_password@db:5432/denno_meishi
NEXT_PUBLIC_SITE_URL=https://yourdomain.com

# ã€æ–°è¦è¿½åŠ ã€‘Cloudflare Tunnelã®èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
# â€»ã”è‡ªèº«ã®ç’°å¢ƒã«åˆã‚ã›ã¦çµ¶å¯¾ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼ˆä¾‹ã¯Linux/VPSã®å ´åˆï¼‰
CLOUDFLARED_CREDENTIALS=/root/.cloudflared/<YOUR_TUNNEL_ID>.json
```

-----

## âš™ï¸ Phase 3: Cloudflare Tunnel ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚µãƒ¼ãƒãƒ¼ã§`cloudflared`ãƒã‚¤ãƒŠãƒªã‚’å®Ÿè¡Œã—ã€Cloudflare Dashboardã¨é€£æºã•ã›ã¾ã™ã€‚

#### ã‚¹ãƒ†ãƒƒãƒ— 3.1: `cloudflared` ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨èªè¨¼

1.  **`cloudflared`ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ï¼ˆLinux/VPSãªã©ï¼‰ã®OSã«åˆã‚ã›ã¦`cloudflared`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
2.  **ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼**: ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§Cloudflareã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€å¯¾è±¡ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’é¸æŠã—ã¾ã™ã€‚
    ```bash
    cloudflared tunnel login
    ```
    ã“ã‚Œã«ã‚ˆã‚Šã€**èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«**ãŒ`~/.cloudflared/cert.pem`ã«ä½œæˆã•ã‚Œã¾ã™ã€‚

#### ã‚¹ãƒ†ãƒƒãƒ— 3.2: Tunnelã®ä½œæˆã¨IDå–å¾—ï¼ˆCloudflare Dashboard æ“ä½œï¼‰

1.  **Cloudflare Dashboard**ã‚’é–‹ãã€**Zero Trust** \> **Access** \> **Tunnels**ã«ç§»å‹•ã—ã¾ã™ã€‚
2.  \*\*ã€ŒCreate a Tunnelã€\*\*ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ä»»æ„ã®åå‰ï¼ˆä¾‹: `denno-meishi`ï¼‰ã‚’ä»˜ã‘ã¦Tunnelã‚’ä½œæˆã—ã¾ã™ã€‚
3.  ä½œæˆå¾Œã€ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹**Tunnel ID**ã‚’æ§ãˆã¾ã™ã€‚
4.  ã‚µãƒ¼ãƒãƒ¼ã«æˆ»ã‚Šã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦Tunnelè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
    ```bash
    cloudflared tunnel create denno-meishi
    ```
    ã“ã‚Œã«ã‚ˆã‚Šã€`~/.cloudflared/<TUNNEL_ID>.json`ã«**ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«**ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’`.env`ã®`CLOUDFLARED_CREDENTIALS`ã«è¨­å®šã—ã¾ã™ã€‚

#### ã‚¹ãƒ†ãƒƒãƒ— 3.3: DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¨­å®šï¼ˆCloudflare Dashboard æ“ä½œï¼‰

1.  Cloudflare Dashboardã§ã€ã‚ãªãŸã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®**DNS**ç®¡ç†ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚
2.  **CNAME**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’2ã¤è¿½åŠ ã—ã¾ã™ã€‚
      * **ã‚¿ã‚¤ãƒ—**: `CNAME`
      * **åå‰**: `yourdomain.com` (`@`) / **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: `<TUNNEL_ID>.cfargotunnel.com`
      * **ã‚¿ã‚¤ãƒ—**: `CNAME`
      * **åå‰**: `www` / **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: `<TUNNEL_ID>.cfargotunnel.com`
      * **ğŸ’¡ãƒ’ãƒ³ãƒˆ**: `cloudflared tunnel route dns denno-meishi yourdomain.com`ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€DNSè¨­å®šã‚’è‡ªå‹•åŒ–ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

-----

## âœ… Phase 4: ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®æœ€çµ‚ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒ—ãƒ­ã‚¤

#### ã‚¹ãƒ†ãƒƒãƒ— 4.1: åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ

1.  **ç’°å¢ƒå¤‰æ•°ã®æº–å‚™**: `.env.example`ã‚’ã‚³ãƒ”ãƒ¼ã—ã€**Phase 2.3**ã«å¾“ã£ã¦`.env`ã‚’ç·¨é›†ã—ã¾ã™ã€‚
    ```bash
    cp .env.example .env
    # .envãƒ•ã‚¡ã‚¤ãƒ«ã¨cloudflared-config.ymlã‚’ç·¨é›†
    ```
2.  **Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰**:
    ```bash
    docker-compose build
    ```
3.  **ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•**:
    ```bash
    docker-compose up -d
    ```
4.  **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: DBãŒ`service_healthy`ã«ãªã‚‹ã¾ã§æ•°ç§’å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¾ã™ã€‚
    ```bash
    docker-compose exec app npx prisma migrate deploy
    ```

#### ã‚¹ãƒ†ãƒƒãƒ— 4.2: å‹•ä½œç¢ºèª

1.  **ãƒ­ã‚°ã®ç¢ºèª**: `app`ã‚µãƒ¼ãƒ“ã‚¹ã¨`cloudflared`ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚¨ãƒ©ãƒ¼ãªãèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
    ```bash
    docker-compose logs -f
    ```
2.  **ã‚µã‚¤ãƒˆã‚¢ã‚¯ã‚»ã‚¹**: è¨­å®šã—ãŸURLï¼ˆ`https://yourdomain.com`ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µã‚¤ãƒˆãŒè¡¨ç¤ºã•ã‚Œã€ã‚³ãƒ³ã‚¿ã‚¯ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ï¼ˆAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰ãŒæ­£å¸¸ã«æ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

#### ã‚¹ãƒ†ãƒƒãƒ— 4.3: åœæ­¢ã‚³ãƒãƒ³ãƒ‰

```bash
# ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã—ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
docker-compose down

# ãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚‚å«ã‚ã¦å®Œå…¨ã«å‰Šé™¤ã™ã‚‹å ´åˆ
docker-compose down -v
```